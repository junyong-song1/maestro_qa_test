{% extends "qa_monitor/base.html" %}
{% load static %}

{% block title %}{{ run_name }} 상세{% endblock %}
{% block page_title %}테스트런 상세 정보{% endblock %}
{% block page_subtitle %}{{ run_name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    {% if error %}
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
        <strong>오류:</strong> {{ error }}
    </div>
    {% else %}
    
    <!-- Top Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-2 bg-blue-100 rounded-lg">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">총 테스트</p>
                    <p class="text-2xl font-bold text-gray-900">{{ run_data.total_tests }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-2 bg-green-100 rounded-lg">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">성공률</p>
                    <p class="text-2xl font-bold text-gray-900">{{ run_data.success_rate|floatformat:1 }}%</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-2 bg-yellow-100 rounded-lg">
                    <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">평균 실행시간</p>
                    <p class="text-2xl font-bold text-gray-900">{{ run_data.avg_elapsed|floatformat:1 }}초</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-2 bg-purple-100 rounded-lg">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">총 실행시간</p>
                    <p class="text-2xl font-bold text-gray-900">{{ run_data.total_elapsed|floatformat:1 }}초</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Distribution -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">상태별 분포</h3>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
            <div class="text-center">
                <div class="text-2xl font-bold text-green-600">{{ run_data.passed }}</div>
                <div class="text-sm text-gray-600">성공</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-red-600">{{ run_data.failed }}</div>
                <div class="text-sm text-gray-600">실패</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-orange-600">{{ run_data.blocked }}</div>
                <div class="text-sm text-gray-600">차단</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-gray-600">{{ run_data.untested }}</div>
                <div class="text-sm text-gray-600">미테스트</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-blue-600">{{ run_data.retest }}</div>
                <div class="text-sm text-gray-600">재테스트</div>
            </div>
        </div>
    </div>

    <!-- Filter Buttons -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex flex-wrap gap-2 mb-4">
            <button class="filter-btn active px-4 py-2 rounded-lg text-sm font-medium transition-colors" data-status="all">
                전체 ({{ total_testcases }})
            </button>
            <button class="filter-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors" data-status="성공">
                성공 ({{ run_data.passed }})
            </button>
            <button class="filter-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors" data-status="실패">
                실패 ({{ run_data.failed }})
            </button>
            <button class="filter-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors" data-status="차단">
                차단 ({{ run_data.blocked }})
            </button>
            <button class="filter-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors" data-status="미테스트">
                미테스트 ({{ run_data.untested }})
            </button>
            <button class="filter-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors" data-status="재테스트">
                재테스트 ({{ run_data.retest }})
            </button>
        </div>
        <div class="text-sm text-gray-600">
            <span id="filter-count">{{ total_testcases }}</span>개의 테스트케이스가 표시됩니다.
        </div>
    </div>

    <!-- Test Cases Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">테스트케이스 목록</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">테스트케이스</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">실행시간</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">API 호출</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">단말기</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상세</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="testcase-table">
                    {% for testcase in testcases %}
                    <tr class="testcase-row" data-status="{{ testcase.status }}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div>
                                <div class="text-sm font-medium text-gray-900">{{ testcase.step_name }}</div>
                                <div class="text-sm text-gray-500">ID: {{ testcase.id }}</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if testcase.status == '성공' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    성공
                                </span>
                            {% elif testcase.status == '실패' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                    실패
                                </span>
                            {% elif testcase.status == '차단' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                                    차단
                                </span>
                            {% elif testcase.status == '미테스트' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                    미테스트
                                </span>
                            {% elif testcase.status == '재테스트' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    재테스트
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                    {{ testcase.status }}
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ testcase.elapsed|floatformat:1 }}초
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div>{{ testcase.api_stats.calls }}건</div>
                            {% if testcase.api_stats.failed > 0 %}
                                <div class="text-red-600 text-xs">{{ testcase.api_stats.failed }}건 실패</div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div>{{ testcase.model }}</div>
                            <div class="text-gray-500 text-xs">{{ testcase.os_version }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="showTestCaseDetail('{{ testcase.id }}')" class="text-indigo-600 hover:text-indigo-900">
                                상세보기
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<!-- Test Case Detail Modal -->
<div id="testcase-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900" id="modal-title">테스트케이스 상세 정보</h3>
                <button onclick="closeTestCaseDetail()" class="text-gray-400 hover:text-gray-600" aria-label="닫기">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="modal-content">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<style>
.filter-btn {
    background-color: #f3f4f6;
    color: #6b7280;
}

.filter-btn:hover {
    background-color: #e5e7eb;
}

.filter-btn.active {
    background-color: #3b82f6;
    color: white;
}

.testcase-row {
    transition: opacity 0.2s ease-in-out;
}

.testcase-row.hidden {
    display: none;
}
</style>

<script>
// Filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const filterButtons = document.querySelectorAll('.filter-btn');
    const testcaseRows = document.querySelectorAll('.testcase-row');
    const filterCount = document.getElementById('filter-count');
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            const status = this.getAttribute('data-status');
            
            // Update active button
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Filter rows
            let visibleCount = 0;
            testcaseRows.forEach(row => {
                const rowStatus = row.getAttribute('data-status');
                if (status === 'all' || rowStatus === status) {
                    row.classList.remove('hidden');
                    visibleCount++;
                } else {
                    row.classList.add('hidden');
                }
            });
            
            // Update count
            filterCount.textContent = visibleCount;
        });
    });
});

// Modal functionality
function showTestCaseDetail(testCaseId) {
    const modal = document.getElementById('testcase-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');
    
    // Find test case data
    const testcaseRows = document.querySelectorAll('.testcase-row');
    let testcaseData = null;
    
    testcaseRows.forEach(row => {
        const idElement = row.querySelector('.text-sm.text-gray-500');
        if (idElement && idElement.textContent.includes(testCaseId)) {
            const stepName = row.querySelector('.text-sm.font-medium').textContent;
            const status = row.getAttribute('data-status');
            const elapsed = row.querySelector('td:nth-child(3)').textContent;
            const apiCalls = row.querySelector('td:nth-child(4)').textContent.trim();
            const device = row.querySelector('td:nth-child(5)').textContent.trim();
            
            testcaseData = {
                id: testCaseId,
                stepName: stepName,
                status: status,
                elapsed: elapsed,
                apiCalls: apiCalls,
                device: device
            };
        }
    });
    
    if (testcaseData) {
        modalTitle.textContent = `테스트케이스 ${testCaseId} 상세 정보`;
        modalContent.innerHTML = `
            <div class="space-y-4">
                <div>
                    <h4 class="font-medium text-gray-900">기본 정보</h4>
                    <div class="mt-2 space-y-2 text-sm">
                        <div><span class="font-medium">테스트케이스 ID:</span> ${testcaseData.id}</div>
                        <div><span class="font-medium">스텝명:</span> ${testcaseData.stepName}</div>
                        <div><span class="font-medium">상태:</span> ${testcaseData.status}</div>
                        <div><span class="font-medium">실행시간:</span> ${testcaseData.elapsed}</div>
                        <div><span class="font-medium">단말기:</span> ${testcaseData.device}</div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-medium text-gray-900">API 호출 정보</h4>
                    <div class="mt-2 text-sm text-gray-600">
                        ${testcaseData.apiCalls}
                    </div>
                </div>
                
                <div>
                    <h4 class="font-medium text-gray-900">실행 로그</h4>
                    <div class="mt-2 text-sm text-gray-600">
                        이 기능은 향후 구현 예정입니다.
                    </div>
                </div>
            </div>
        `;
    }
    
    modal.classList.remove('hidden');
}

function closeTestCaseDetail() {
    const modal = document.getElementById('testcase-modal');
    modal.classList.add('hidden');
}

// Close modal when clicking outside
document.getElementById('testcase-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeTestCaseDetail();
    }
});
</script>
{% endblock %} 